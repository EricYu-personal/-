<!DOCTYPE html>
<!-- Copyright © 2020~2021 by wzh -->
<html lang="zh">
	<head>
		<meta charset="UTF-8" />
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
		<title>我的世界 | 登录</title>
		
		<!--icon-->
		<link href="./img/icon.png" rel="icon" type="image/x-icon"/>
		
		<!-- 异步fonts加载 -->
		<script src="https://staticfile.qnssl.com/webfont/1.6.16/webfontloader.js"></script>
		<script>
		if (typeof require != "undefined"){ //electron
			console.log("electron")
			document.write(`<link href="./css/fonts.css" rel="stylesheet" type="text/css" />`);
			window.onload = function(){
				console.log("onload")
				$("body").addClass("wf-active");
			}
		}else{
			WebFont.load({
				google: {
					families: ["kt", "st", "xs", "zyyt"],
					api: "./css/fonts.css"
				}
			});
		}
		</script>
		
		<style>
		/* 字体加载完成 */
		.wf-active *{
			font-family: zyyt, serif;
			outline: none;
		}
		.wf-active h1,
		.wf-active h2,
		.wf-active h3,
		.wf-active h4{
			font-family: st, serif;
		}
		.wf-active p,
		.wf-active label{
			font-family: kt, serif;
		}
		.wf-active button{
			font-family: xs, serif;
			font-weight: bold;
		}
		
		
		/* 字体缩放方案 */
		@media screen and (max-width:320px){
			body {font-size: 0.8rem;}
		}
		@media screen and (min-width: 321px) and (max-width:481px){
			body {font-size: 1rem;}
		}
		@media screen and (min-width: 481px) and (max-width:640px){
			body {font-size: 1.1rem;}
		}
		@media screen and (min-width: 641px) and (max-width:800px){
			body {font-size: 1.15rem;}
		}
		@media screen and (min-width: 801px) and (max-width:960px){
			body {font-size: 1.25rem;}
		}
		@media screen and (min-width: 960px){
			body {font-size: 1.3rem;}
		}
		
		/* element */
		html{
			-moz-user-select: none;
			-khtml-user-select: none;
			user-select: none;
		}
		body, input{
			background-color: #F6F6F6;
		}
		p{
			margin: 0;
			font-size: 0.36em;
		}
		button{
			border-radius: 6px;
		}
		label{
			font-weight: bold;
		}
		input{
			height: 6.8vw;
			font-size: 1.1em;
			border: 1px solid #aaa;
			border-radius: 3px;
		}
		
		
		#view{
			height: 100%;
		}
		h1{
			margin: 2.6rem;
			text-align: center;
			font-size: 3em;
		}
		
		form > div{
			padding: 1vw;
		}
		form > div > input{
			width: 100%;
		}
		
		form > div:last-of-type{
			display: flex;
		}
		form > div > button{
			font-size: 2em;
			width: 46%;
			margin: 0 auto;
		}
		form > div > button:first-of-type{
			color: white;
			background-color: #1e9fff;
			border: 3px solid #1e9fff;
		}
		form > div > button:first-of-type:hover{
			background-color: #0e8fef;
			border: 3px solid #0e8fef;
		}
		
		form > div > button:last-of-type{
			color: #1e9fff;
			background-color: #fff;
			border: 3px solid #1e9fff;
		}
		form > div > button:last-of-type:hover{
			background-color: #eee;
		}
		
		#messages{
			position: absolute;
			top: 0;
			right: 0;
			margin: 0.3rem;
		}
		#messages > article{
			display: block;
			width: 260px;
			margin: 0.6rem;
			padding: 0.3rem;
			background-color: white;
			border-radius: 1px;
			box-shadow: 0 0 1px 2px rgba(160, 160, 160, 0.6);
		}
		#messages > article > h3{
			margin: 0;
			font-size: 1.36em;
		}
		#messages > article > p{
			font-size: 1.2em;
		}
		</style>
		
		<!-- layui -->
		<!--<link rel="stylesheet" href="https://unpkg.com/layui@2.6.4/dist/css/layui.css">-->
		<script src="https://unpkg.com/layui@2.6.4/dist/layui.js"></script>
		
		<script src="./js/modules/sha512.js"></script>
		<script src="./js/modules/jquery.min.js"></script>
		<script>
		if (typeof require != "undefined") //electron
			window.$ = window.jQuery = require("./js/modules/jquery.min.js");
		</script>
		<script src="./js/modules/js+.js"></script>
		
		<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
		<script src="https://cdn.bootcss.com/vConsole/3.3.4/vconsole.min.js"></script>
		<script>
		if ( /ipad|iphone|midp|rv:1.2.3.4|ucweb|android|windows ce|windows mobile/.test( navigator.userAgent.toLowerCase() ) ){
			//手机
			eruda.init();
			new VConsole();
		}
		</script>
		
	</head>
	<body>
		<section id="view" class="layui-main layui-unselect">
			<h1>登录<p>LOGIN</p></h1>
			<form>
				<div>
					<label>用户名：</label><br/><input name="name" placeholder="用户名" />
				</div>
				<div>
					<label>密码：</label><br/><input name="password" placeholder="密码" type="password" />
				</div>
				<div class="layui-btn-container">
					<button class="success layui-btn layui-btn-primary layui-bg-blue" lay-submit lay-filter="login" type="button" id="login">登录</button>
					<button class="success layui-btn layui-bg-gray" lay-submit lay-filter="login" type="button" id="register">注册</button>
				</div>
			</form>
		</section>
		
		<section id="messages"></section>
		
		<!-- 流量统计 -->
		<div style="display: none;">
			<script language="javascript" src="http://count24.51yes.com/click.aspx?id=248466766&logo=12" charset="gb2312"></script>
		</div>
		
<script>
//请求服务器
function request(method, path="", value=""){
	return new Promise((resolve, reject)=>{
		console.log(method, path, value)
		$.ajax({
			url: "https://wzh.glitch.me/data/" + method,
			data: {path, value},
			type: "GET",
			dataType: "jsonp",
			success: (response, status, xhr)=>{
				console.log({method, path, value}, response)
				resolve(response);
			}
		});
	});
}

//消息
function message(title, text, color="#3af", time=3){
	const e = $("<article></article>")
		.append( $("<h3></h3>")
			.html(title)
			.css("color", color)
		)
		.append( $("<p></p>").html(text) );
	$("#messages").append(
		e.css("marginLeft", "160px")
		.hide()
		.show("slow")
		.animate({marginLeft: "0px"}, "slow")
	);
}

const ROOT = "/MinecraftCommunity/",
	USERS = ROOT + "users/",
	CHAT = ROOT + "chat/default/",
	users = [];

async function main(){
	let res;
	
	res = await request("makeDir", USERS);
	if (res != true){
		console.error("makeDir", USERS, res);
		alert("操作错误\nresult:"+JSON.stringify(res));
	}
	
	res = await request("makeDir", CHAT);
	if (res != true){
		console.error("makeDir", CHAT, res);
		alert("操作错误\nresult:"+JSON.stringify(res));
	}
	
	res = await request("readDir", USERS);
	for (const user of res){
		res = await request("readFile", USERS+user);
		const lines = res.split("\n");
		users.push({
			regTime: lines[0],
			password: lines[1],
			info: JSON.parse(lines[2])
		});
	}
}
let inited = false;
main().then(() => init=true); //初始化完成


$("#login").click(function(){
	if (!init) return layer.msg("获取用户信息中……", {icon: 5});
	const {name:{value:name}, password:{value:password}} = $("form")[0];
	console.log("login", name, password)
	
	for (const user of users)
		if (user.name == name && user.password == hex_sha512(hex_sha512(password))){
			localStorage.setItem("name", name);
			localStorage.setItem("password", hex_sha512(password));
			layer.msg("登录成功！", {icon: 1});
			location.href = "./community.html";
			return;
		}
	
	layer.msg("用户名或密码错误", {icon: 2});
});

$("#register").click(function(){
	if (!init) return layer.msg("获取用户信息中……", {icon: 5});
	const {name:{value:name}, password:{value:password}} = $("form")[0];
	console.log("register", name, password)
	
	for (const user of users)
		if (user.name == name){
			return layer.msg("该用户已存在", {icon: 5});
		}
	
	request("writeFile", USERS+name,
		+new Date()+"\n"+
		hex_sha512(hex_sha512(password))+"\n"+
		"{}"
	).then(()=>{
		localStorage.setItem("name", name);
		localStorage.setItem("password", hex_sha512(password));
		layer.msg("注册成功！", {icon: 1});
		location.href = "./community.html";
	});
});
</script>
	</body>
</html>
