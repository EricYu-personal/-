<!DOCTYPE html>
<!-- Copyleft 2020~2021 by wzh -->
<html lang="zh">
	<head>
		<meta charset="UTF-8" />
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
		<title>我的世界 | 交流区</title>
		
		<!--icon-->
		<link href="./img/icon.png" rel="icon" type="image/x-icon"/>
		
		<!-- 异步fonts加载 -->
		<script src="./js/modules/webfontloader.js"></script>
		<script>
		if (typeof require != "undefined"){ //electron
			console.log("electron")
			document.write(`<link href="./css/fonts.css" rel="stylesheet" type="text/css" />`);
			window.onload = function(){
				console.log("onload")
				$("body").addClass("wf-active");
			}
		}else{
			WebFont.load({
				google: {
					families: ["kt", "st", "xs", "zyyt"],
					api: "./css/fonts.css"
				}
			});
		}
		</script>
		
		<style>
		/* 字体缩放方案 */
		@media screen and (max-width:320px){
			body {font-size: calc(0.016 * 320px + 9px);}
		}
		body{
			font-size: calc(1.6vw + 9px);
		}
		@media screen and (min-width: 960px){
			body {font-size: calc(0.016 * 960px + 9px);}
		}
		/* 横屏 */
		body.landscape{
			margin: 0 20vw;
		}
		
		/* element */
		html{
			-moz-user-select: none;
			-khtml-user-select: none;
			user-select: none;
		}
		body{
			background-color: #f6f6f6;
			text-align: center;
		}
		small{
			display: block;
			margin: 0;
			font-size: 0.36em;
		}
		section > h1{
			margin: 2rem;
			font-size: 3em;
		}
		button{
			border-radius: 6px;
		}
		code{
			background-color: rgba(236, 236, 236, 0.8);
		}
		blockquote{
			background-color: rgba(236, 236, 236, 0.8);
		}
		/*blockquote:before{
			width: 0.2rem;
			height: 100%;
			background-color: #aaa;
		}*/
		textarea{ /*禁止调整大小*/
			resize: none;
		}
		
		
		/* chat */
		#chat{
			position: absolute;
			left: 0;
			top: 0;
			display: flex;
			flex-direction: column;
			width: 100%;
			height: 100%;
			background-color: #fffae8;
		}
		
		#chat > header{
			flex: none;
			height: 2rem;
			padding: 0.6rem;
			background-color: #cef;
		}
		#chat > header > span{ /* 返回 */
			position: absolute;
			display: inline-block;
			left: 0.1rem;
			height: 2rem;
			
			border: none;
			font-size: 1.2em;
			line-height: 2rem;
		}
		#chat > header > span:active{
			background-color: #bde;
		}
		#chat > header > h2{
			margin: 0;
			font-size: 1.6em;
			line-height: 2rem;
		}
		
		#messagesList{
			width: 100%;
			height: 100%;
			overflow-y: auto;
			margin: 0;
			padding: 0;
			border-radius: 6px;
		}
		#messagesList > li{
			display: flex;
			flex-direction: column;
			margin: 0.6rem;
			padding: 0;
		}
		#messagesList > li > time{ /* time */
			display: inline-block;
			margin: 0 auto;
			padding: 0.1rem 0.2rem;
			
			background-color: rgba(236, 236, 236, 0.8);
			border-radius: 10px;
			font-size: 0.8em;
		}
		#messagesList > li > div{ /* main */
			display: flex;
			text-align: left;
		}
		#messagesList > li.right > div{
			flex-direction: row-reverse;
		}
		#messagesList > li > div > span{ /* icon */
			display: inline-block;
			width: 2rem;
			height: 2rem;
			margin: 0.2rem;
			flex: none;
			
			background-color: #d3e0ed;
			border-radius: 50%;
			font-size: 1.1em;
			text-align: center;
			line-height: 2rem;
		}
		#messagesList > li > div > span.v:after{
			content: "V";
			position: relative;
			top: -2rem;
			left: 2rem;
			display: block;
			width: 0.6rem;
			height: 0.6rem;
			
			color: white;
			background-color: #00f;
			border-radius: 50%;
			font-size: 0.3em;
			text-align: center;
			line-height: 0.6rem;
		}
		#messagesList > li > div > div{ /* name,message */
			display: inline-flex;
			flex-direction: column;
		}
		#messagesList > li > div > div > span{ /* name */
			margin: 0.1rem;
			color: grey;
			font-size: 0.8em;
		}
		#messagesList > li.right > div > div > span{
			text-align: right;
		}
		#messagesList > li > div > div > article{ /* message */
			margin: 0.1rem;
			padding: 0.2rem;
			background-color: #e0edd3;
			border-radius: 6px;
			user-select: text; /* 可复制 */
			word-break: break-all; /* 自动换行 */
		}
		#messagesList > li > div > div > article > *{
			font-family: zyyt; /* 字体修正 */
		}
		
		#chat > form{
			display: flex;
			flex: none;
			height: 3rem;
			margin: 1px;
		}
		#chat > form > textarea{
			width: 100%;
			height: 2.6rem;
			background-color: white;
			border: 1px solid #6af;
			border-radius: 3px;
			text-align: left;
		}
		#chat > form > button{
			flex: none;
			/* width: calc(3vw + 40px); */
			
			border: 1px solid #6af;
			font-size: 1em;
			background-color: #cef;
		}
		#chat > form > button:active{
			background-color: #bde;
		}
		
		
		/* noscript */
		noscript{
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: #fffae8;
			text-align: center;
		}
		</style>
		
		<!-- jquery -->
		<script src="./js/modules/jquery.min.js"></script>
		<script>
		if (typeof require != "undefined") //electron
			window.$ = window.jQuery = require("./js/modules/jquery.min.js");
		</script>
		
		<!-- layui -->
		<!--<link rel="stylesheet" href="https://unpkg.com/layui@2.6.4/dist/css/layui.css">-->
		<script src="./js/modules/layui.js"></script>
		
		<!-- 调试工具 -->
		<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
		<script src="https://cdn.bootcss.com/vConsole/3.3.4/vconsole.min.js"></script>
		<script>
		if ( /ipad|iphone|midp|rv:1.2.3.4|ucweb|android|windows ce|windows mobile/.test( navigator.userAgent.toLowerCase() ) ){
			//手机
			eruda.init();
			new VConsole();
		}
		</script>
		
		<script src="./js/modules/sha512.js"></script> <!-- sha加密 -->
		<script src="./js/modules/marked.min.js"></script> <!-- markdown -->
		
		<script src="./js/modules/js_plus.min.js"></script> <!-- js+ -->
		<script src="https://wzh656.github.io/MinecraftWeb/js/modules/count.js"></script> <!-- 流量统计
		
	</head>
	<body>
		<!-- 聊天界面 -->
		<section id="chat">
			<header>
				<span class="exit">〈退出</span>
				<h2>我的世界讨论区</h2>
			</header>
			<ul id="messagesList">
				<span>获取中……</span>
			</ul>
			<form>
				<textarea id="message" placeholder="shift+Enter发送（支持markdown/html格式）" contenteditable></textarea>
				<button type="button" id="send">发送</button>
			</form>
		</section>
		
		<!-- 1:不支持js -->
		<noscript style="z-index: 1;"><h1>你的浏览器不支持JavaScript，无法运行！</h1></noscript>
		
<script>
if (window.innerWidth > window.innerHeight)
	$("body").addClass("landscape"); //横屏
$(window).resize(function(){
	if (window.innerWidth < window.innerHeight)
		$("body").removeClass("landscape"); //取消横屏
});
</script>

<script>
//发送消息
function send(name, msg, attr={}){
	return new Promise((resolve, reject)=>{
		console.log("send", name, msg, attr)
		$.ajax({
			url: "https://wzh.glitch.me/chatroom/MinecraftCommunity/send",
			data: {name, msg, attr},
			type: "GET",
			dataType: "jsonp",
			success: (response, status, xhr)=>{
				console.log("send", {name, msg, attr}, response)
				resolve(response);
			},
			error: (response, status, xhr)=>{
				alert(`发送请求错误！\nstatus: ${status}\nresponse: ${response}`);
				reject(response, status, xhr);
			}
		});
	});
}
function get(date){
	return new Promise((resolve, reject)=>{
		console.log("send", date)
		$.ajax({
			url: "https://wzh.glitch.me/chatroom/MinecraftCommunity/get",
			data: {date},
			type: "GET",
			dataType: "jsonp",
			success: (response, status, xhr)=>{
				console.log("send", {date}, response)
				resolve(response);
			},
			error: (response, status, xhr)=>{
				alert(`发送请求错误！\nstatus: ${status}\nresponse: ${response}`);
				reject(response, status, xhr);
			}
		});
	});
}



let name = localStorage.getItem("MinecraftCommunity_name");
while (!name){
	name = prompt("请输入你的昵称");
	localStorage.setItem("MinecraftCommunity_name", name);
}



get(new Date().format("yyyy-MM-dd")).then(res => {
	for (const {time, name, msg, attr} of res)
		$("messagesList").append(
			$("<li></li>")
				.data("time", +data.time)
				.addClass(data.name==user.name? "right": "left")
				.append(
					$("<time></time>").html( data.time.format("yyyy/MM/dd hh:mm:ss") )
				)
				.append( //main
					$("<div></div>")
					.append( //icon
						$("<span></span>").html( data.name.substr(0,1) )
							.addClass( data.name=="wzh"? "v": ""  )
					)
					.append( //name, message
						$("<div></div>")
						.append( //name
							$("<span></span>").html( data.name )
						)
						.append( //message
							$("<article>"+data.message+"</article>")
						)
					)
				)
		);
});



// 发送消息
async function sendMessage(){
	if (!user) return layer.msg("请先登录", {icon: 5});
	if (!$("#message").val()) return update(); //无输入 刷新
	
	const waitLayerId = layer.load(2);
	
	const message = marked( $("#message").val() ).replace(/\n+/g, "").replace(/<script[\s\S]+<\/script>/g, ""),
		file = CHAT+sectionName+"/"+new Date().format("yyyy-MM-dd")+".dat",
		value = +new Date()+"\n"+
			user.name+"\n"+
			message+"\n"+
			"{}";
	
	let res;
	res = await request("exists", file);
	if (res === true){ //已存在，追加文件
		res = await request("appendFile", file, "\n"+value);
		if (res !== true){
			console.error("appendFile", file, res);
			return alert("操作错误！\nmethod: appendFile\nresult:"+JSON.stringify(res));
		}
	}else if (res === false){ //不存在，写入文件
		res = await request("writeFile", file, value);
		if (res !== true){
			console.error("writeFile", file, res);
			return alert("操作错误！\nmethod: writeFile\nresult:"+JSON.stringify(res));
		}
	}
	$("#message").val(""); //清除发送框内容
	update();
	
	layer.close(waitLayerId);
}



//新建板块
$("#exit").click(()=>history.back());
//发送消息
$("#send").click(sendMessage);
$("#message").keydown(function(e){
	if (e.keyCode == 13 && e.shiftKey){
		sendMessage(); //shift+回车
		e.stopPropagation();
		e.cancelBubble = true;
		return false;
	}
});
</script>
	</body>
</html>
